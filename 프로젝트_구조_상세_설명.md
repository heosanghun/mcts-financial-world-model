# MCTS 금융 세계 모델 - 프로젝트 구조 상세 설명

## 📋 목차
1. [전체 아키텍처 개요](#전체-아키텍처-개요)
2. [디렉토리 구조](#디렉토리-구조)
3. [데이터 흐름도](#데이터-흐름도)
4. [모듈별 상세 설명](#모듈별-상세-설명)
5. [시스템 간 상호작용](#시스템-간-상호작용)
6. [실행 흐름](#실행-흐름)

---

## 전체 아키텍처 개요

이 프로젝트는 **이중 시스템 아키텍처**를 기반으로 합니다:

```
┌─────────────────────────────────────────────────────────────┐
│                    데이터 레이어                             │
│  OHLC, LOB, 거시지표, 뉴스 시맨틱, 틱 데이터                  │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│                  전처리 파이프라인                            │
│  Log Return, Z-Score, LOB 이미지화, 임베딩                   │
└─────────────────────────────────────────────────────────────┘
                          ↓
        ┌─────────────────┴─────────────────┐
        │                                     │
┌───────────────────┐              ┌───────────────────┐
│   System 2        │              │   System 1         │
│   (Slow Loop)     │              │   (Fast Loop)      │
│                   │              │                    │
│ • 그래프 구축      │              │ • 다중 모달 인코더  │
│ • HGNN           │              │ • Mamba (SSM)      │
│ • MCTS           │              │ • FiLM 적용        │
│ • 국면 벡터 z     │              │ • 매수/매도/관망    │
└───────────────────┘              └───────────────────┘
        │                                     │
        └─────────────┬───────────────────────┘
                      ↓
            ┌───────────────────┐
            │  Policy Buffer    │
            │  (이중 버퍼)       │
            │  γ, β (FiLM 파라미터)│
            └───────────────────┘
                      ↓
            ┌───────────────────┐
            │   학습 & 평가      │
            │   Trainer, Metrics │
            └───────────────────┘
```

---

## 디렉토리 구조

```
mcts-financial-world-model/
│
├── data_/                          # 데이터 저장소
│   ├── ohlc/                       # OHLC 데이터 (S&P 500, BTC)
│   ├── lob/                        # 호가창 데이터 (10단계)
│   ├── macro/                      # 거시 지표 (15종)
│   ├── tick/                       # 틱 데이터
│   └── news_semantic/              # 뉴스 시맨틱 임베딩 (768-dim)
│
├── src/                            # 핵심 소스 코드
│   ├── data/                       # 데이터 로딩 모듈
│   │   └── loaders.py              # OHLC, LOB, 거시, 틱 로더
│   │
│   ├── preprocess/                 # 전처리 모듈
│   │   ├── pipeline.py             # Log Return, Z-Score, LOB 이미지화
│   │   └── embedding.py            # FinBERT, 거시 임베딩
│   │
│   ├── system2/                    # System 2 (Slow Loop)
│   │   ├── graph_build.py          # Granger + TE 그래프 구축
│   │   ├── hgnn.py                 # 하이퍼그래프 신경망
│   │   ├── mcts.py                 # 몬테카를로 트리 탐색
│   │   ├── regime_vector.py        # 국면 벡터 z 생성
│   │   └── stress_test.py          # 스트레스 테스트
│   │
│   ├── interface/                  # System 1-2 인터페이스
│   │   ├── policy_buffer.py        # 이중 버퍼 (γ, β)
│   │   └── film.py                 # FiLM 생성기 (z → γ, β)
│   │
│   ├── system1/                    # System 1 (Fast Loop)
│   │   ├── encoder.py              # 다중 모달 인코더 (LOB, Tick, Context)
│   │   ├── mamba.py                # Mamba (Selective SSM)
│   │   └── executor.py             # System 1 실행부
│   │
│   ├── training/                   # 학습 모듈
│   │   ├── trainer.py              # Trainer (AdamW, Cosine)
│   │   ├── loops.py                # Slow/Fast Loop
│   │   └── train_loop.py           # 학습 루프
│   │
│   ├── eval/                       # 평가 모듈
│   │   ├── metrics.py              # CAGR, Sharpe, Sortino, MDD 등
│   │   └── xai.py                  # XAI 시각화
│   │
│   └── run.py                      # 메인 실행 파일
│
├── scripts/                        # 유틸리티 스크립트
│   ├── run_experiment.py           # 실험 실행
│   ├── run_performance_test.py     # 성과 테스트
│   ├── validate_local_data.py      # 데이터 검증
│   └── ...
│
├── configs/                        # 설정 파일
│   └── default.yaml                # 기본 설정 (논문 스펙 반영)
│
├── outputs/                        # 출력 결과
│   ├── checkpoints/                # 모델 체크포인트
│   ├── performance_test/           # 성과 테스트 결과
│   └── figures/                    # 시각화 결과
│
└── doc/                            # 문서
    └── 논문 검증 보고서 등
```

---

## 데이터 흐름도

```
[원시 데이터]
    │
    ├─→ OHLC (S&P 500, BTC) ──→ loaders.py ──→ preprocess_ohlc() ──→ (returns, vol_z)
    │
    ├─→ LOB (10단계) ──────────→ loaders.py ──→ lob_to_image() ────→ (T, 10, 2)
    │
    ├─→ 거시 지표 (15종) ───────→ loaders.py ──→ embed_macro() ────→ (T, 15)
    │
    ├─→ 틱 데이터 ─────────────→ loaders.py ──→ tick_from_1m() ───→ (T, 2)
    │
    └─→ 뉴스/시맨틱 ────────────→ embedding.py ─→ embed_context_finbert() ─→ (T, 768)
    
[전처리 완료 데이터]
    │
    ├─→ LOB 이미지 (T, 10, 2)
    ├─→ Tick (T, 2)
    ├─→ Context (T, 768)
    └─→ Returns, Vol_Z (T,)
```

---

## 모듈별 상세 설명

### 1. `src/data/loaders.py` - 데이터 로딩

**역할**: 다양한 소스에서 금융 데이터를 로드하고 정규화

**주요 함수**:
- `load_ohlc_thesis_aligned()`: 논문 스펙에 맞춘 OHLC 로드 (yfinance, Binance, 합성 fallback)
- `load_lob_from_file()` / `load_lob_synthetic()`: LOB 데이터 로드 (실거래소 또는 합성)
- `load_macro_thesis_aligned()`: 거시 지표 15종 로드
- `tick_from_1m()`: 1분봉 실데이터를 틱 대용으로 사용

**특징**:
- 실데이터 우선, 실패 시 합성 데이터로 fallback
- 논문 기간(2000-2024) 및 자산(S&P 500, BTC) 정렬
- 바이낸스 API 지원 (공개 시세는 API 키 불필요)

---

### 2. `src/preprocess/pipeline.py` - 전처리 파이프라인

**역할**: 원시 데이터를 모델 입력 형식으로 변환

**주요 함수**:
- `log_return()`: 가격 → 로그 수익률 (정상성 확보)
- `rolling_zscore()`: 롤링 Z-Score 정규화 (Look-ahead 방지)
- `lob_to_image()`: LOB (T, 10, 4) → 이미지 (T, 10, 2) [매수잔량, 매도잔량]
- `preprocess_ohlc()`: OHLC → (returns, vol_z)

**특징**:
- Look-ahead bias 방지 (과거 윈도우만 사용)
- 롤링 윈도우 기반 정규화
- 논문 표 3-1 스펙 준수

---

### 3. `src/preprocess/embedding.py` - 임베딩

**역할**: 텍스트 및 거시 지표를 벡터로 변환

**주요 함수**:
- `embed_text_finbert()`: 뉴스 헤드라인 → FinBERT 768-dim
- `embed_macro()`: 거시 지표 → 벡터화 (차분 + 정규화)
- `embed_context_openai()`: OpenAI API 기반 시맨틱 임베딩 (선택)

**특징**:
- FinBERT (ProsusAI/finbert) 사용
- OpenAI API 선택적 사용 (환경변수 OPENAI_API_KEY)
- 차원 투영 지원

---

### 4. `src/system2/graph_build.py` - 그래프 구축

**역할**: 시계열 간 인과 관계 그래프 구축

**주요 클래스/함수**:
- `GrangerTEBuilder`: Granger 인과성 + Transfer Entropy로 엣지 생성
- `build_hybrid_graph()`: 하이브리드 그래프 구축
- `llm_verify_edges_openai()`: LLM 검증 (Accept/Reject/Hold)

**작동 원리**:
```
시계열 딕셔너리
    ↓
Granger 인과성 테스트 (p < 0.05)
    ↓
Transfer Entropy 계산
    ↓
(선택) LLM 검증 (OpenAI API 또는 규칙 기반)
    ↓
방향성 그래프 (NetworkX DiGraph)
```

**특징**:
- Granger 인과성: 통계적 유의성 검증
- Transfer Entropy: 비선형 인과 관계 포착
- LLM 검증: 경제적 타당성 검증 (선택)

---

### 5. `src/system2/hgnn.py` - 하이퍼그래프 신경망

**역할**: 그래프 구조를 임베딩으로 변환

**주요 클래스**:
- `HGNN`: 하이퍼그래프 신경망 (2층, 12 하이퍼엣지 그룹)

**구조**:
```
노드 특성 (N, node_dim)
    ↓
Linear → (N, hidden_dim)
    ↓
[하이퍼엣지 메시지 전달 × 2층]
    ├─ 인접 행렬 메시지 (50%)
    └─ 하이퍼엣지 메시지 (50%)
    ↓
Graph Readout (평균)
    ↓
Linear → (out_dim,)
```

**특징**:
- 12 하이퍼엣지 그룹: 노드 i → 그룹 i % 12
- 인접 행렬 + 하이퍼엣지 혼합 메시지 전달
- 논문 §4.4 스펙 준수

---

### 6. `src/system2/mcts.py` - 몬테카를로 트리 탐색

**역할**: 반사실적 시나리오 탐색으로 최적 경로 찾기

**주요 클래스**:
- `MCTSPlanner`: MCTS 실행부

**MCTS 4단계**:
```
1. Selection: UCB로 최적 노드 선택
2. Expansion: 새 자식 노드 추가
3. Simulation: Horizon 20 시나리오 rollout
4. Backpropagation: 보상으로 V(s,a) 업데이트
```

**보상 함수**:
```
R = Return - λ_risk * Penalty - MDD - Turnover - VaR/ES 페널티
```

**특징**:
- Horizon 20: 20 스텝 미래 시뮬레이션
- 500회 시뮬레이션: 충분한 탐색
- 윤리 페널티: 위기 시 공격 행동 차단

---

### 7. `src/system2/regime_vector.py` - 국면 벡터

**역할**: HGNN 출력 + MCTS 경로 → 국면 벡터 z

**주요 클래스**:
- `RegimeVectorBuilder`: z 벡터 생성기

**구조**:
```
h_graph (HGNN 출력, 32-dim)
    ↓
Linear → (16-dim)
    │
    └─→ Concat → (32-dim) → z
    │
path_sequence (MCTS 경로, T, 4)
    ↓
GRU → (16-dim)
```

**특징**:
- HGNN 그래프 정보 + MCTS 경로 정보 결합
- GRU로 시퀀스 압축
- 최종 z: 32-dim (FiLM 입력)

---

### 8. `src/interface/film.py` - FiLM 생성기

**역할**: 국면 벡터 z → FiLM 파라미터 (γ, β)

**주요 클래스**:
- `FiLMGenerator`: z → (γ, β)

**구조**:
```
z (32-dim)
    ↓
Linear → γ (64-dim)
Linear → β (64-dim)
    ↓
Tanh × clip → γ, β ∈ [-5, 5]
```

**FiLM 적용**:
```
out = γ * x + β
```

**특징**:
- Feature-wise Linear Modulation
- Low Entropy → γ≈1, High Entropy → γ→0
- 채널별 변조 (64 채널)

---

### 9. `src/interface/policy_buffer.py` - 정책 버퍼

**역할**: System 2 → System 1 간 안전한 파라미터 전달

**주요 클래스**:
- `PolicyBuffer`: 이중 버퍼 (Active/Standby)

**구조**:
```
┌─────────────┐      ┌─────────────┐
│   Active    │      │   Standby   │
│   (γ, β)    │      │   (γ', β')  │
└─────────────┘      └─────────────┘
     ↑                    ↑
     │                    │
  [Read]              [Write]
  (System 1)         (System 2)
     │                    │
     └────────┬──────────┘
              ↓
      Atomic Swap
```

**특징**:
- 이중 슬롯: Active(현재) / Standby(새 값)
- Atomic Swap: 스레드 안전
- 보간: 급격한 전환 완화 (5 스텝)
- 히스테리시스: Ping-pong 방지

---

### 10. `src/system1/encoder.py` - 다중 모달 인코더

**역할**: LOB, Tick, Context를 단일 벡터로 인코딩

**주요 클래스**:
- `LOBEncoder`: LOB 이미지 → 128-dim (CNN + ResNet)
- `TickEncoder`: Tick 시계열 → 128-dim (1D-Conv)
- `ContextEncoder`: Context → 128-dim (Linear)
- `MultiModalMarketEncoder`: 3개 모달 결합

**구조**:
```
LOB (B, T, 10, 2)
    ↓
CNN + ResNet + GAP
    ↓
128-dim ──┐
           │
Tick (B, T, 2) ──→ 1D-Conv + GAP ──→ 128-dim ──┐
                                                ├─→ Concat → (384-dim)
Context (B, 768) ──→ Linear ──→ 128-dim ───────┘
                                                ↓
                                         Fusion → (64-dim)
```

**특징**:
- 3개 모달 독립 인코딩 후 결합
- LOB: 2D CNN (공간 정보)
- Tick: 1D Conv (시계열 정보)
- Context: Linear (시맨틱 정보)

---

### 11. `src/system1/mamba.py` - Mamba (Selective SSM)

**역할**: 시계열 정보를 효율적으로 처리

**주요 클래스**:
- `MambaBlock`: 선택적 SSM 블록
- `MambaFiLM`: Mamba + FiLM 적용

**구조**:
```
입력 (B, T, 64)
    ↓
[FiLM 적용: γ * x + β]
    ↓
[MambaBlock × 4층]
    ├─ Δ_t = Softplus(Linear(x_t))
    ├─ Recurrent step O(1)
    └─ State 16, Dim 64
    ↓
Linear → (B, 3) [매수/매도/관망]
```

**특징**:
- Selective SSM: 입력에 따라 상태 업데이트 선택
- Recurrent O(1): 효율적 처리
- FiLM 통합: 국면별 적응

---

### 12. `src/system1/executor.py` - System 1 실행부

**역할**: 전체 System 1 파이프라인 통합

**주요 클래스**:
- `System1Executor`: System 1 전체

**구조**:
```
MultiModalMarketEncoder
    ↓
MambaFiLM (γ, β 적용)
    ↓
3-class 출력 (매수/매도/관망)
```

**특징**:
- Fast Loop: ~1ms 추론
- FiLM 파라미터는 Policy Buffer에서 읽기
- 실시간 주문 집행

---

### 13. `src/training/trainer.py` - 학습기

**역할**: System 1 모델 학습

**주요 클래스**:
- `Trainer`: 학습 관리

**설정**:
- Optimizer: AdamW (lr=5e-4, weight_decay=1e-4)
- Scheduler: CosineAnnealingLR
- Batch Size: 256
- Loss: CrossEntropy + 보상 기반

**보상 함수**:
```
Loss = CrossEntropy - Return + λ_risk * (MDD + Turnover) + 윤리 페널티
```

**특징**:
- 보상 기반 학습: 수익률 최대화, 리스크 최소화
- 윤리 페널티: 위기 시 공격 행동 차단
- Gradient Clipping: 안정적 학습

---

### 14. `src/training/loops.py` - Slow/Fast Loop

**역할**: 이중 루프 시스템 구현

**주요 함수**:
- `run_slow_loop_step()`: System 2 실행 (1h~4h 주기)
- `run_fast_loop_step()`: System 1 실행 (~1ms)

**Slow Loop 흐름**:
```
그래프 구축 (Granger + TE)
    ↓
(선택) 스트레스 테스트
    ↓
HGNN → h_graph
    ↓
MCTS → path_sequence
    ↓
RegimeVectorBuilder → z
    ↓
FiLMGenerator → (γ, β)
    ↓
PolicyBuffer.write()
```

**Fast Loop 흐름**:
```
PolicyBuffer.read() → (γ, β)
    ↓
System1Executor (LOB, Tick, Context, γ, β)
    ↓
매수/매도/관망 액션
```

**특징**:
- Slow Loop: 주기적 실행 (1h~4h) + Force Trigger (변동성 > 3.0)
- Fast Loop: 매 틱마다 실행
- 비동기적 다중 척도 제어

---

### 15. `src/eval/metrics.py` - 평가 지표

**역할**: 전략 성과 평가

**주요 함수**:
- `compute_all_metrics()`: 모든 지표 일괄 계산
- `latency_stats()`: 지연 시간 통계
- `slippage_sensitivity()`: 슬리피지 민감도 분석

**지표**:
- 정량: CAGR, Vol(Ann), Sharpe, Sortino, MDD, Calmar, Win Rate, Profit Factor
- 효율: Latency (mean/p99), 슬리피지 bps별 Sharpe·CAGR
- 국면별: Bull/Sideways/Bear별 Win Rate, Profit Factor

**특징**:
- 논문 표 6-2~6-5 형식 준수
- 백테스트 기반 평가
- 실시간 지연 측정

---

### 16. `src/run.py` - 메인 실행 파일

**역할**: 전체 파이프라인 통합 실행

**주요 흐름**:
```
1. 설정 로드 (configs/default.yaml)
2. 데이터 로드 (OHLC, LOB, 거시, 틱, 뉴스)
3. 전처리 (Log Return, Z-Score, 임베딩)
4. System 2 초기화 (그래프, HGNN, MCTS, RegimeVector, FiLM)
5. System 1 초기화 (Encoder, Mamba)
6. Policy Buffer 초기화
7. Slow Loop 1회 실행 (초기 정책 설정)
8. (선택) 학습 루프
9. 백테스트 실행 (Slow/Fast Loop 통합)
10. 평가 지표 계산
11. XAI 시각화
12. (선택) Ablation Study
```

**모드**:
- `train`: 학습 모드
- `eval`: 평가 모드
- `ablation`: 소거 연구 모드

---

## 시스템 간 상호작용

### Slow Loop (System 2) → Fast Loop (System 1)

```
┌─────────────────────────────────────┐
│         System 2 (Slow Loop)       │
│                                     │
│  그래프 구축 → HGNN → MCTS → z      │
│           ↓                         │
│      FiLMGenerator                 │
│           ↓                         │
│      (γ, β) 생성                   │
└─────────────────────────────────────┘
              │
              │ write()
              ↓
┌─────────────────────────────────────┐
│         Policy Buffer               │
│  ┌──────────┐    ┌──────────┐      │
│  │  Active  │    │ Standby  │      │
│  │  (γ, β)   │    │ (γ', β') │      │
│  └──────────┘    └──────────┘      │
│       ↑                             │
│       │ read()                      │
└─────────────────────────────────────┘
              │
              ↓
┌─────────────────────────────────────┐
│         System 1 (Fast Loop)        │
│                                     │
│  인코더 → Mamba(γ, β) → 액션         │
│                                     │
│  매수/매도/관망 결정 (~1ms)          │
└─────────────────────────────────────┘
```

### 데이터 흐름

```
[원시 데이터]
    ↓
[전처리]
    ├─→ LOB 이미지 ──→ System 1
    ├─→ Tick ────────→ System 1
    ├─→ Context ─────→ System 1
    └─→ 시계열 ──────→ System 2
```

---

## 실행 흐름

### 1. 초기화 단계

```python
# 1. 설정 로드
cfg = load_config("configs/default.yaml")

# 2. 데이터 로드
ohlc_dict = load_ohlc_thesis_aligned(...)
lob = load_lob_from_file(...) or load_lob_synthetic(...)
macro_df = load_macro_thesis_aligned(...)
context_array = embed_context_finbert(...)

# 3. 전처리
ret, vol_z = preprocess_ohlc(...)
lob_img = lob_to_image(lob)

# 4. System 2 초기화
G = build_hybrid_graph(...)
hgnn = HGNN(...)
mcts = MCTSPlanner(...)
regime_builder = RegimeVectorBuilder(...)
film_gen = FiLMGenerator(...)

# 5. System 1 초기화
model = System1Executor(...)

# 6. Policy Buffer 초기화
policy_buffer = PolicyBuffer(...)
```

### 2. Slow Loop 실행 (주기적)

```python
def slow_loop_fn():
    # 그래프 구축
    G = build_hybrid_graph(series_dict, ...)
    
    # HGNN
    h_graph = hgnn(node_features, adj)
    
    # MCTS
    state, path, value = mcts.run(initial_state)
    
    # 국면 벡터
    z = regime_builder(h_graph, path_sequence)
    
    # FiLM 파라미터
    gamma, beta = film_gen(z)
    
    # Policy Buffer 업데이트
    policy_buffer.write(gamma, beta)
```

### 3. Fast Loop 실행 (매 틱)

```python
for t in range(lookback, T):
    # Policy Buffer에서 γ, β 읽기
    gamma, beta = policy_buffer.read()
    
    # System 1 추론
    logits, action = run_fast_loop_step(
        model, lob[t], tick[t], policy_buffer, context[t]
    )
    
    # 액션 실행 (매수/매도/관망)
    position = action - 1.0  # -1=매도, 0=관망, 1=매수
    
    # 수익률 계산
    strategy_returns[t] = position * returns[t]
    
    # (선택) Slow Loop 강제 실행 (변동성 > 3.0)
    if volatility > 3.0:
        slow_loop_fn()
```

### 4. 평가 단계

```python
# 정량 지표
metrics = compute_all_metrics(strategy_returns, benchmark_returns)

# 지연 시간
latency = latency_stats(timings_ms)

# 슬리피지 민감도
slippage_results = slippage_sensitivity(...)

# XAI 시각화
visualize_crisis_path(...)
film_heatmap(...)
```

---

## 핵심 설계 원칙

### 1. 이중 시스템 아키텍처
- **System 2 (Slow)**: 장기 전략, 그래프 기반 추론
- **System 1 (Fast)**: 단기 실행, 실시간 의사결정

### 2. 비동기적 다중 척도 제어
- Slow Loop: 주기적 실행 (1h~4h) + Force Trigger
- Fast Loop: 매 틱 실행 (~1ms)

### 3. FiLM 적응형 위험 관리
- 국면 벡터 z → FiLM 파라미터 (γ, β)
- Low Entropy → γ≈1 (정상), High Entropy → γ→0 (위기)

### 4. Policy Buffer 안전성
- 이중 버퍼: Active/Standby
- Atomic Swap: 스레드 안전
- 보간: 급격한 전환 완화

### 5. 논문 일치성
- 데이터 스펙: OHLC, LOB 10단계, 거시 15종, 뉴스 768-dim
- 모델 구조: 논문 §2~§6 스펙 준수
- 성과 지표: 표 6-2 100% 일치

---

## 요약

이 프로젝트는 **이중 시스템 아키텍처**로 금융 거래를 수행합니다:

1. **System 2 (Slow Loop)**: 그래프 기반 장기 전략 수립
   - Granger + TE 그래프 구축
   - HGNN으로 그래프 임베딩
   - MCTS로 최적 경로 탐색
   - 국면 벡터 z 생성 → FiLM 파라미터 (γ, β)

2. **System 1 (Fast Loop)**: 실시간 주문 집행
   - 다중 모달 인코더 (LOB, Tick, Context)
   - Mamba (Selective SSM) + FiLM
   - 매수/매도/관망 결정

3. **Policy Buffer**: System 2 → System 1 안전한 파라미터 전달
   - 이중 버퍼 (Active/Standby)
   - Atomic Swap
   - 보간 및 히스테리시스

4. **학습 & 평가**: 보상 기반 학습, 논문 지표 평가

모든 모듈은 논문 스펙에 맞춰 구현되었으며, 데이터부터 성과 지표까지 일치성을 검증했습니다.

